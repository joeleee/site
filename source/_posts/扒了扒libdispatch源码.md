---
title: æ‰’äº†æ‰’libdispatchæºç 
date: 2017-02-21 15:47:10

categories:
- Objective-C

tags:
- libdispatch
- GCD
---

å‰å‡ å¤©æ‰’äº†ä¸€ä¸‹libdispatchçš„æºç ï¼Œå½“å‰æœ€æ–°çš„æ˜¯ libdispatch-703.30.5.tarï¼Œä¹‹å‰ä¹Ÿåœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€äº›åšå®¢ï¼Œå‘ç°æºç æœ‰ç‚¹å¯¹ä¸ä¸Šï¼Œåº”è¯¥æ˜¯ä»£ç æ¯”è¾ƒè€äº†å§ã€‚ä¹‹å‰å¯¹GCDçš„è®¤è¯†éƒ½æ¯”è¾ƒæµ…ï¼š

* ä¸€ç›´æœ‰ä¸ªè¯¯åŒºè®¤ä¸º ***dispatch_sync*** æ˜¯å¡ä½å½“å‰çº¿ç¨‹ï¼Œç„¶åå»å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œï¼ŒåŸæ¥å¹¶ä¸æ˜¯å¦‚æ­¤ï¼›
* ä¸€ç›´è®¤ä¸º ***dispatch\_sync*** æ­»é”çš„æ˜¯çº¿ç¨‹ï¼ŒåŸæ¥å¹¶ä¸æ˜¯å¦‚æ­¤ï¼›
* ä¸€ç›´ä¸æ˜¯å¾ˆæ¸…æ¥š ***libdispatch*** ä¸­ ***é˜Ÿåˆ—*** å’Œ ***çº¿ç¨‹*** æ˜¯å¦‚ä½•åä½œçš„
* ä¸€ç›´æƒ³çŸ¥é“ ***dispatch_barrier*** æ˜¯æ€ä¹ˆå®ç°çš„
* ......

å¥½äº†ï¼Œæ¥æ¥æ¥ï¼Œæ‰’æ‰’æºç å°±å…¨çŸ¥é“äº†ï¼Œå½“ç„¶æºç ä¸­æˆ‘è¿˜æ˜¯æœ‰å¾ˆå¤šç–‘æƒ‘çš„åœ°æ–¹ï¼Œå¸Œæœ›å¤§å®¶æ‹ï¼Œåæ­£æˆ‘åªæ˜¯æ¬è¿å·¥ï¼Œå“ˆå“ˆğŸ˜„
***

# å…¨æ™¯ #

### ç»“æ„å›¾ ###
å…ˆçœ‹è¿™å¼ æ³›æ»¥äº†çš„å›¾å§ï¼š

![gcd-pool](/images/gcd-pool.png)

ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å¾—åˆ°çš„ä¿¡æ¯æ˜¯ï¼š

1. åªæœ‰ ***Main-Queue*** çš„ä»»åŠ¡å¯ä»¥æäº¤åˆ° ***Main-Thread*** ä¸Š
2. ç³»ç»Ÿæä¾›çš„æ‰€æœ‰çš„ ***Default-Queues*** ä¼šå…±äº«ä¸€ä¸ª ***Thread-Pool***
3. æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„æ‰€æœ‰ ***Custom-Queues*** éƒ½ä¼šå’Œ ***Default-Queues*** æœ‰æŸç§è”ç³»
4. å…³äºçº¿ç¨‹çš„ä»»åŠ¡è°ƒåº¦ç”¨æˆ·ä¸èƒ½ä¹Ÿä¸éœ€è¦å‚ä¸

### å…³é”®æ•°æ®ç»“æ„ ###
å…ˆè®°ä¸‹å‡ ä¸ªå…³é”®çš„æ•°æ®ç»“æ„å§ï¼Œç­‰ä¼šå„¿å¥½è¿”å›æ¥æŸ¥ï¼Œæœ‰ä¸ªä¸œè¥¿æå‰è¯´æ˜ä¸€ä¸‹ï¼š

è¿™äº›ç»“æ„ä½“éƒ½ä¼šæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ ***\*\*\*_t*** å¦ä¸€ä¸ªæ˜¯ ***\*\*\*_s*** ï¼Œå…¶ä¸­ ***\*\*\*_t*** æ˜¯ ***\*\*\*_s*** çš„æŒ‡é’ˆç±»å‹ï¼Œ_sæ˜¯ç»“æ„ä½“ã€‚æ¯”å¦‚ dispatch\_queue\_t å’Œ dispatch\_queue\_sã€‚

***dispatch\_object\_s*** è¿™ä¸ªç»“æ„ä½“å¯ä»¥ä»£è¡¨æ‰€æœ‰çš„ ***gcdå¯¹è±¡***ï¼Œæˆ‘è¯´OCä¸­çš„ ***id*** ç±»å‹ï¼Œä½ ä¸€å®šå°±çŸ¥é“æ˜¯ä»€ä¹ˆäº†ã€‚

#### dispatch\_continuation\_s ####
``` c
struct {
	struct dispatch_object_s *volatile do_next; // ä¸‹ä¸€ä¸ªä»»åŠ¡
	dispatch_function_t dc_func;                // æ‰§è¡Œçš„æ–¹æ³•
	void *dc_ctxt;                              // æ–¹æ³•ä¸Šä¸‹æ–‡
	void *dc_data;                              // ç›¸å…³æ•°æ®
	void *dc_other                              // å…¶å®ƒä¿¡æ¯
}
```

#### dispatch\_queue\_s ####
``` c
struct {
	struct dispatch_queue_s *do_targetq;               // ç›®æ ‡é˜Ÿåˆ—ï¼Œè¿™ä¸ªæœ€ç»ˆä¼šæŒ‡å‘ä¸€ä¸ªç³»ç»Ÿçš„é»˜è®¤é˜Ÿåˆ—
	struct dispatch_object_s *volatile dq_items_head;  // é˜Ÿåˆ—å¤´éƒ¨
	struct dispatch_object_s *volatile dq_items_tail;  // é˜Ÿåˆ—å°¾éƒ¨
	unsigned long dq_serialnum;                        // é˜Ÿåˆ—åºå·
	const char *dq_label;                              // é˜Ÿåˆ—å
	dispatch_priority_t dq_priority;                   // ä¼˜å…ˆçº§
	dispatch_priority_t volatile dq_override;          // æ˜¯å¦è¢«è¦†ç›–
	uint16_t dq_width;                                 // å¯å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡æ•°
	dispatch_queue_t dq_specific_q;                    // ç‰¹æ®Šé˜Ÿåˆ—
	uint32_t dq_side_suspend_cnt;                      // æš‚åœçš„ä»»åŠ¡æ•°
}
```

---
æœªå®Œï¼Œæ˜å¤©ç»§ç»­...